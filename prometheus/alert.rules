groups:
  - name: events-api-alerts
    rules:
      # Alerta para alta taxa de erro
      - alert: HighErrorRate
        expr: rate(http_requests_total{status_code=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }} errors per second"

      # Alerta para latência alta
      - alert: HighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High latency detected"
          description: "95th percentile latency is {{ $value }} seconds"

      # Alerta para aplicação down
      - alert: ApplicationDown
        expr: up{job="events-api"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Events API is down"
          description: "The events API has been down for more than 1 minute"

      # Alerta para muitas requisições simultâneas
      - alert: HighRequestRate
        expr: rate(http_requests_total[5m]) > 100
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High request rate detected"
          description: "Request rate is {{ $value }} requests per second"

      # Alerta para eventos com muitos participantes
      - alert: EventNearCapacity
        expr: (attendees_registered_total / events_active) > 0.8
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "Event near capacity"
          description: "An event is reaching its capacity limit"

      # Alerta para erros de banco de dados
      - alert: DatabaseErrors
        expr: rate(errors_total{error_type=~"database.*"}[5m]) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Database errors detected"
          description: "Database errors are occurring at {{ $value }} per second"

      # Alerta para conexões de banco altas
      - alert: HighDatabaseConnections
        expr: database_connections_active > 80
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High database connections"
          description: "Database has {{ $value }} active connections"

      # Alerta para queries lentas
      - alert: SlowDatabaseQueries
        expr: histogram_quantile(0.95, rate(database_query_duration_seconds_bucket[5m])) > 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Slow database queries detected"
          description: "95th percentile query time is {{ $value }} seconds"
